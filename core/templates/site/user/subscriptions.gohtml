{{ template "head" $ }}
<h2>Your Subscriptions</h2>

<form method="post" action="/usr/subscriptions/update">
    {{ csrfField }}
    {{ range .Groups }}
    {{ $group := . }}
    <div class="subscription-group">
        <h3>{{ .Name }}</h3>
        <p>{{ .Description }}</p>

        {{ if .Instances }}
        <table>
            <thead>
                <tr>
                    <th>Target</th>
                    <th>Internal</th>
                    <th>Email</th>
                    {{ if .SupportsAutoSubscribe }}
                    <th>Auto-subscribe Internal</th>
                    <th>Auto-subscribe Email</th>
                    {{ end }}
                </tr>
            </thead>
            <tbody>
                {{ $defPattern := .Pattern }}
                {{ range .Instances }}
                {{ $pattern := .Original }}
                {{ if eq $pattern "" }}{{ $pattern = $defPattern }}{{ end }}
                <tr>
                    <td>
                        {{/* Display parameters nicely */}}
                        {{ if .Parameters }}
                            {{ range .Parameters }}
                                {{ .Key }}:
                                {{ if .Link }}
                                    <a href="{{ .Link }}">{{ if .Resolved }}{{ .Resolved }}{{ else }}{{ .Value }}{{ end }}</a>
                                {{ else }}
                                    {{ if .Resolved }}{{ .Resolved }}{{ else }}{{ .Value }}{{ end }}
                                {{ end }}
                            {{ end }}
                        {{ else }}
                            All
                        {{ end }}
                    </td>
                    <td>
                        <input type="checkbox" name="subs" value="{{ $pattern }}|internal" {{ if .HasMethod "internal" }}checked{{ end }}>
                        <input type="hidden" name="presented_subs" value="{{ $pattern }}|internal">
                    </td>
                    <td>
                        <input type="checkbox" name="subs" value="{{ $pattern }}|email" {{ if .HasMethod "email" }}checked{{ end }}>
                        <input type="hidden" name="presented_subs" value="{{ $pattern }}|email">
                    </td>
                    {{ if $group.SupportsAutoSubscribe }}
                    <td>
                        <input type="checkbox" name="subs" value="{{ $pattern }}|autosub_internal" {{ if .HasMethod "autosub_internal" }}checked{{ end }}>
                        <input type="hidden" name="presented_subs" value="{{ $pattern }}|autosub_internal">
                    </td>
                    <td>
                        <input type="checkbox" name="subs" value="{{ $pattern }}|autosub_email" {{ if .HasMethod "autosub_email" }}checked{{ end }}>
                        <input type="hidden" name="presented_subs" value="{{ $pattern }}|autosub_email">
                    </td>
                    {{ end }}
                </tr>
                {{ end }}
            </tbody>
        </table>
        {{ else }}
        <p>No subscriptions.</p>
        {{ end }}
    </div>
    {{ end }}

    <p>
        <input type="submit" value="Update Subscriptions" class="button">
    </p>
</form>

<p>
    <a href="/usr/subscriptions/add" class="button">Add Subscription</a>
    <a href="/usr/subscriptions/threads" class="button">Manage Thread Subscriptions</a>
</p>

{{ template "tail" $ }}
