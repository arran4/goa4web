# GOA4Web

This repository contains the source code for a collection of web services written in Go. The original project dates back to 2006.

Goa4Web is a monolithic web application written in Go. It powers the original `arran4` website, providing a collection of community features including blogs, forums, a bookmark manager and an image board.

The code in this repository exposes all pages using the [Gorilla Mux](https://github.com/gorilla/mux) router and stores its data in MySQL. Templating uses Go's `html/template` package, either embedded in the binary or loaded from disk when built with the `live` tag.

## Features

- **News** – publish posts and allow discussion in comment threads.
- **FAQ** – manage question and answer entries with administrative tools.
- **Blogs** – users can write blogs, comment on posts and subscribe to bloggers.
- **Forum** – a traditional threaded forum with categories, topics and moderation tools.
- **Linker** – a directory of community links with suggestion and approval queues.
- **Bookmarks** – authenticated users can maintain personal bookmark lists.
- **Image BBS** – boards with threaded image posting support.
- **Search** – full-text search across the various sections of the site.
- **Writings** – long form articles organised into categories.
- **User Management** – registration, login, preferences and access control levels.

Most handlers live in a single package and are mapped directly in `main.go` for simplicity. Database queries are generated by [sqlc](https://github.com/kyleconroy/sqlc) which produces the `models.go` file and the `Queries` type found throughout the handlers.

Optional notification emails are sent through [AWS SES](https://aws.amazon.com/ses/). The template for these messages lives under `templates/updateEmail.txt`.

## Getting Started

1. Install Go 1.20 or newer and ensure `go` is available in your `PATH`.
2. Create a MySQL database named `a4web`. The schema is defined in `schema.sql` and can be loaded with:
   ```bash
   mysql -u a4web -p a4web < schema.sql
   ```
3. Provide your database credentials via command line flags, a configuration file, or environment variables. Defaults assume `a4web:a4web@tcp(localhost:3306)/a4web`.
4. Download dependencies and build the application:
   ```bash
   go mod download
   go build -o goa4web
   ```

During development you can load templates directly from the `templates` directory by using the `live` build tag:
```bash
go run -tags live .
```
The default build embeds templates and `main.css` so the resulting binary is self-contained.

## Running

Run the compiled binary and open <http://localhost:8080> in your browser:
```bash
./goa4web
```
The server relies on the MySQL instance and (optionally) AWS credentials for sending email notifications. Most features require users to be logged in; sessions are stored in signed cookies via `gorilla/sessions`.
The secret used to sign these cookies is resolved in the following order:
1. `--session-secret` flag
2. `SESSION_SECRET` environment variable
3. The file specified by `--session-secret-file` or `SESSION_SECRET_FILE` (defaults to `.session_secret`)

If the file does not exist a new random secret is generated and written to it.

Form submissions are protected using the `gorilla/csrf` middleware. Tokens are
embedded in templates (for example the login form) and verified on POST
requests.

## Repository Layout

```
.
├── main.go                – HTTP router and entry point
├── templates/             – HTML templates for all pages
├── schema.sql             – MySQL schema used by the application
├── data_embedded.go       – embed templates and CSS for production builds
├── data_live.go           – load templates from disk in development
├── models.go              – sqlc generated data models
└── queries-*.sql          – SQL queries consumed by sqlc
```

## Testing

Unit tests focus mainly on utility packages and template compilation. Execute all tests with:
```bash
go test ./...
```

---

This project was originally developed for a single server environment and remains a work in progress. Contributions are welcome!

## Database Configuration

Database connection details can be supplied in several ways. Values are resolved in the following order:

1. Command line flags (`--db-user` etc.)
2. Values from a config file specified with `--db-config`
3. Environment variables such as `DB_USER`
4. Built-in defaults

The config file uses the same `key=value` format as the email configuration file.
See `examples/db.conf` for a complete list of supported keys.

## Email Provider Configuration

Email notifications can be sent via several backends. Set `EMAIL_PROVIDER` to select one of the following modes:

- `ses` (default): Amazon SES. Requires valid AWS credentials and `AWS_REGION`.
- `smtp`: Standard SMTP server using `SMTP_HOST`, optional `SMTP_PORT`, `SMTP_USER`, and `SMTP_PASS`.
- `local`: Uses the local `sendmail` binary.
- `jmap`: Sends mail using JMAP. Requires `JMAP_ENDPOINT`, `JMAP_USER`, `JMAP_PASS`,
  `JMAP_ACCOUNT`, and `JMAP_IDENTITY`.
- `sendgrid`: Uses the SendGrid API. Requires the `sendgrid` build tag and a `SENDGRID_KEY`.
- `log`: Writes emails to the application log.

If configuration or credentials are missing, email is disabled and a log message is printed.

Configuration values can also be provided in a file and via command line flags.
The resolution order is:

1. Command line flags (`--smtp-host` etc.)
2. Values from a config file specified with `--email-config`
3. Environment variables such as `SMTP_HOST`
4. Built-in defaults

The config file uses a simple `key=value` format matching the environment
variable names. See `examples/email.conf` for an example file containing all keys.

### Implementing Custom Providers

New email backends can be added by satisfying the `MailProvider` interface
defined in `email.go`:

```go
type MailProvider interface {
    Send(ctx context.Context, to, subject, body string) error
}
```

Create a new file implementing this interface and add a case in
`providerFromConfig` that returns your provider. Providers that rely on optional
dependencies should live behind a build tag. See `email_sendgrid.go` for an
example provider built with the `sendgrid` tag.

## Admin tools

### Permission section checker

The `/admin/permissions/sections` page lists all distinct values found in the `permissions.section` column. It provides buttons to convert existing rows between `writing` and `writings`. These once-off tools help normalise data if older migrations used inconsistent names.
