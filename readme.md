# GOA4Web

This repository contains the source code for a collection of web services written in Go. The original project dates back to 2006.

Goa4Web is a monolithic web application written in Go. It powers the original `arran4` website, providing a collection of community features including blogs, forums, a bookmark manager and an image board.

Project URL: <https://github.com/arran4/goa4web>

The code in this repository exposes all pages using the [Gorilla Mux](https://github.com/gorilla/mux) router and stores its data in a SQL database. MySQL, PostgreSQL and SQLite are supported. SQLite support is optional and requires the `sqlite` build tag when compiling. Templating uses Go's `html/template` package, either embedded in the binary or loaded from disk when built with the `live` tag.

## Features

- **News** – publish posts and allow discussion in comment threads. Writers,
  moderators and administrators may edit posts.
- **FAQ** – manage question and answer entries with administrative tools.
- **Blogs** – users can write blogs, comment on posts and subscribe to bloggers.
- **Forum** – a traditional threaded forum with categories, topics and moderation tools.
- **Linker** – a directory of community links with suggestion and approval queues.
- **Bookmarks** – authenticated users can maintain personal bookmark lists.
- **Image BBS** – boards with threaded image posting support.
- **Search** – full-text search across the various sections of the site.
- **Writings** – long form articles organised into categories.
- **User Management** – registration, login and preference pages. Permissions rely on roles and grants.

Most handlers live in a single package and are mapped directly in `cmd/goa4web/main.go` for simplicity. Database queries are generated by [sqlc](https://github.com/kyleconroy/sqlc) which produces the `internal/db/models.go` file and the `Queries` type found throughout the handlers.

Optional notification emails are sent through [AWS SES](https://aws.amazon.com/ses/). The template for these messages lives under `core/templates/email/updateEmail.gotxt`.

## Getting Started

1. Install Go 1.20 or newer and ensure `go` is available in your `PATH`.
2. Create a database named `a4web` using your preferred server. The schema is defined in `schema/schema.sql` and can be loaded with `mysql` or `psql`.
   ```bash
   mysql -u a4web -p a4web < schema/schema.sql
   ```
   Apply any SQL scripts from the `migrations/` directory to bring the database
   up to date. All table changes should be shipped with a migration script under
   this directory.
   After applying migrations you can insert the initial roles and grants using
   the provided seed file:
   ```bash
   ./goa4web db seed
   ```
3. Provide your database connection string and driver via command line flags, a configuration file, or environment variables. Examples:
   * MySQL TCP: `user:password@tcp(127.0.0.1:3306)/a4web?parseTime=true`
   * MySQL socket: `user:password@unix(/var/run/mysqld/mysqld.sock)/a4web?parseTime=true`
   * PostgreSQL: `postgres://user:pass@localhost/a4web?sslmode=disable`
   * SQLite: `file:./a4web.sqlite?_fk=1`
4. Download dependencies and build the application (SQLite support requires the `sqlite` build tag):
   ```bash
   go mod download
   go build -o goa4web ./cmd/goa4web
   ```

During development you can load templates directly from the `core/templates` directory by using the `live` build tag:
```bash
go run -tags live ./cmd/goa4web
```
The default build embeds templates and `main.css` so the resulting binary is self-contained.

## Running

Run the compiled binary and open <http://localhost:8080> in your browser:
```bash
./goa4web
```
The server relies on the configured database and (optionally) AWS credentials for sending email notifications. Most features require users to be logged in; sessions are stored in signed cookies via `gorilla/sessions`.
The secret used to sign these cookies is resolved in the following order:
1. `--session-secret` flag
2. `SESSION_SECRET` environment variable
3. The file specified by `--session-secret-file` or `SESSION_SECRET_FILE` (a default location is chosen when unset)
   (`GOA4WEB_DOCKER` places it under `/var/lib/goa4web/`)

If the file does not exist a new random secret is generated and written to it.

Form submissions are protected using the `gorilla/csrf` middleware. Tokens are
embedded in templates (for example the login form) and verified on POST
requests.

## Repository Layout

```
.
├── cmd/goa4web/         – HTTP router and entry point
├── config/              – environment variable helpers
├── core/templates/      – HTML and email templates
├── examples/            – generated configuration examples
├── migrations/          – database schema migrations
├── schema/schema.sql    – initial database schema
├── core/templates/embedded.go  – embed templates and CSS for production builds
├── core/templates/live.go      – load templates from disk in development
├── internal/db/models.go       – sqlc generated data models
└── internal/db/queries-*.sql   – SQL queries consumed by sqlc
```

### Section registration

Site sections register their navigation items with the `navigation` package so
menus can be assembled dynamically. Use `navigation.RegisterIndexLink` for public
links and `navigation.RegisterAdminControlCenter` for admin navigation. Each call
accepts a weight value; lower numbers appear first.

Example weights:

```
News        10
FAQ         20
Blogs       30
Forum       40
Linker      50
Bookmarks   60
ImageBBS    70
Search      80
Writings    90
Information 100
```

## Testing

Unit tests focus mainly on utility packages and template compilation. Execute all tests with the `nosqlite` tag:
```bash
go test -tags nosqlite ./...
```

---

This project was originally developed for a single server environment and remains a work in progress. Contributions are welcome!


## Application Configuration File

The path to a general configuration file can be specified with the `--config-file`
flag or the `CONFIG_FILE` environment variable. Command line parsing happens in
two phases: first only this flag is processed so the file location is known. The
file can set values for any configuration key which are applied before the rest
of the flags are parsed.

## Database Configuration

Database connection details are provided via a connection string and driver name.
Values are resolved in the following order:

1. Command line flags (`--db-conn` and `--db-driver`)
2. Values from a config file specified with `--config-file` or `CONFIG_FILE`
3. Environment variables such as `DB_CONN`

The config file uses the same `key=value` format as the email configuration file.
Generate example settings with:
```bash
go run ./cmd/goa4web config as-env-file > examples/config.env
```
Run `goa4web config options --extended` to see detailed descriptions of all
configuration keys.

Example environment based launch:
```bash
DB_DRIVER=sqlite
DB_CONN=file:./a4web.sqlite?_fk=1 \
AUTO_MIGRATE=true ./goa4web serve
```
When using SQLite you must compile the binary with the `sqlite` build tag.

## Email Provider Configuration

Email notifications can be sent via several backends. Set `EMAIL_PROVIDER` to select one of the following modes:

- `ses` (default): Amazon SES. Requires valid AWS credentials and `AWS_REGION`.
  The provider is built only when the `ses` build tag is enabled.
- `smtp`: Standard SMTP server using `SMTP_HOST`, optional `SMTP_PORT`, `SMTP_USER`, `SMTP_PASS`, `SMTP_AUTH`, `SMTP_STARTTLS` and `SMTP_TLS`.
- `local`: Uses the local `sendmail` binary.
- `jmap`: Sends mail using JMAP. Requires `JMAP_ENDPOINT`, `JMAP_USER`, `JMAP_PASS`,
  `JMAP_ACCOUNT`, and `JMAP_IDENTITY`.
- `sendgrid`: Uses the SendGrid API. Requires the `sendgrid` build tag and a `SENDGRID_KEY`.
- `log`: Writes emails to the application log.

When connecting to port `465` you usually need to set `SMTP_TLS=true` and
`SMTP_STARTTLS=false`. Only one of these options should normally be enabled.

If configuration or credentials are missing, email is disabled and a log message is printed.

Configuration values can also be provided in a file and via command line flags.
The resolution order is:

1. Command line flags (`--smtp-host` etc.)
2. Values from a config file specified with `--config-file` or `CONFIG_FILE`
3. Environment variables such as `SMTP_HOST`
4. Built-in defaults

The config file uses a simple `key=value` format matching the environment
variable names.

Administrator change notifications are enabled by default when a valid mail
provider is configured. Set `ADMIN_NOTIFY=false` to disable these messages.

Run `goa4web config as-env-file` to generate a file with all email settings.

## HTTP Server Configuration

The address the HTTP server listens on and the base URL used for absolute URLs
can be configured the same way as other settings:

1. Command line flags (`--listen` and `--hostname`)
2. Values from a config file specified with `--config-file` or `CONFIG_FILE`
3. Environment variables `LISTEN` and `HOSTNAME`
4. Built-in defaults (`:8080` and `http://localhost:8080`)

See `examples/config.env` for an auto-generated configuration file.

`HOSTNAME` should include the scheme and optional port, e.g. `http://example.com`.

## Pagination Configuration

The allowed page size range and default value are resolved in the following order:

1. Command line flags (`--page-size-min`, `--page-size-max`, `--page-size-default`)
2. Values from a config file specified with `--config-file` or `CONFIG_FILE`
3. Environment variables (`PAGE_SIZE_MIN`, `PAGE_SIZE_MAX`, `PAGE_SIZE_DEFAULT`)
4. Built-in defaults (5, 50 and 15)
Administrators can temporarily adjust these limits through `/admin/page-size`. This only changes the running configuration; update the config file to retain the values after a restart.
Individual users can override the default value for their account via `/usr/paging`.

## Configuration Reference

All settings can be supplied on the command line, via a configuration file or
through environment variables. Flags override values in the config file which in
turn override environment variables. The file uses the same keys as the
environment variables listed below.
| Key | CLI Flag | Required | Default | Description |
| --- | --- | --- | --- | --- |
| `DB_CONN` | `--db-conn` | Yes | - | Database connection string. |
| `DB_DRIVER` | `--db-driver` | Yes | `mysql` | Database driver name. |
| `EMAIL_PROVIDER` | `--email-provider` | No | `ses` | Selects the mail sending backend. |
| `EMAIL_FROM` | `--email-from` | No | - | Default From address for outgoing mail. Must be a valid RFC 5322 address. |
| `EMAIL_SIGNOFF` | `--email-signoff` | No | - | Optional sign off text appended to emails. |
| `SMTP_HOST` | `--smtp-host` | No | - | SMTP server hostname. |
| `SMTP_PORT` | `--smtp-port` | No | - | SMTP server port. |
| `SMTP_USER` | `--smtp-user` | No | - | SMTP username. |
| `SMTP_PASS` | `--smtp-pass` | No | - | SMTP password. |
| `SMTP_AUTH` | `--smtp-auth` | No | `plain` | SMTP authentication method (plain, login, cram-md5). |
| `SMTP_STARTTLS` | `--smtp-starttls` | No | `true` | Enable or disable STARTTLS. |
| `AWS_REGION` | `--aws-region` | No | - | AWS region for the SES provider. |
| `JMAP_ENDPOINT` | `--jmap-endpoint` | No | - | JMAP API endpoint. |
| `JMAP_ACCOUNT` | `--jmap-account` | No | - | JMAP account identifier. |
| `JMAP_IDENTITY` | `--jmap-identity` | No | - | JMAP identity identifier. |
| `JMAP_USER` | `--jmap-user` | No | - | Username for the JMAP provider. |
| `JMAP_PASS` | `--jmap-pass` | No | - | Password for the JMAP provider. |
| `CONFIG_FILE` | `--config-file` | No | - | Path to the main configuration file. |
| `EMAIL_ENABLED` | n/a | No | `true` | Toggles sending queued emails. |
| `NOTIFICATIONS_ENABLED` | n/a | No | `true` | Toggles the internal notification system. |
| `CSRF_ENABLED` | n/a | No | `true` | Enables or disables CSRF protection. |
| `FEEDS_ENABLED` | `--feeds-enabled` | No | `true` | Toggles RSS and Atom feed generation. |
| `PAGE_SIZE_MIN` | `--page-size-min` | No | `5` | Minimum allowed page size. |
| `PAGE_SIZE_MAX` | `--page-size-max` | No | `50` | Maximum allowed page size. |
| `PAGE_SIZE_DEFAULT` | `--page-size-default` | No | `15` | Default page size. |
| `STATS_START_YEAR` | `--stats-start-year` | No | `2005` | First year displayed on the usage stats page. |
| `DB_LOG_VERBOSITY` | `--db-log-verbosity` | No | `0` | Database logging verbosity. |
| `LOG_FLAGS` | `--log-flags` | No | `0` | Bit mask selecting HTTP request logs. |
| `LISTEN` | `--listen` | No | `:8080` | Network address the HTTP server listens on. |
| `HOSTNAME` | `--hostname` | No | `http://localhost:8080` | Base URL advertised by the HTTP server. |
| `SESSION_SECRET` | `--session-secret` | No | generated | Secret used to encrypt session cookies. |
| `SESSION_SECRET_FILE` | `--session-secret-file` | No | auto | File containing the session secret. |
| `GOA4WEB_DOCKER` | n/a | No | - | Set when running inside Docker to adjust defaults. |
| `SENDGRID_KEY` | `--sendgrid-key` | No | - | API key for the SendGrid email provider. |
| `EMAIL_WORKER_INTERVAL` | `--email-worker-interval` | No | `60` | Minimum seconds between queued email sends. |
| `PASSWORD_RESET_EXPIRY_HOURS` | `--password-reset-expiry-hours` | No | `24` | Hours a password reset request remains valid. |
| `ADMIN_EMAILS` | `--admin-emails` | No | - | Comma-separated list of administrator email addresses. |
| `ADMIN_NOTIFY` | n/a | No | `true` | Toggles sending administrator notification emails. |
| `IMAGE_UPLOAD_DIR` | `--image-upload-dir` | No | `uploads/images` | Directory where uploaded images are stored when using the local provider. |
| `IMAGE_UPLOAD_PROVIDER` | `--image-upload-provider` | No | `local` | Upload backend to use. |
| `IMAGE_UPLOAD_S3_URL` | `--image-upload-s3-url` | No | - | S3 prefix URL for uploads when using the S3 provider. |
| `IMAGE_CACHE_PROVIDER` | `--image-cache-provider` | No | `local` | Cache backend to use. |
| `IMAGE_CACHE_S3_URL` | `--image-cache-s3-url` | No | - | S3 prefix URL for cache when using the S3 provider. |
| `IMAGE_CACHE_DIR` | `--image-cache-dir` | No | `uploads/cache` | Directory for cached thumbnails when using the local provider. |
| `IMAGE_CACHE_MAX_BYTES` | `--image-cache-max-bytes` | No | `-1` | Maximum image cache size in bytes. |
| `IMAGE_MAX_BYTES` | `--image-max-bytes` | No | `5242880` | Maximum allowed size of uploaded images. |
| `DEFAULT_LANGUAGE` | `--default-language` | No | - | Site's default language name. |
| `DLQ_PROVIDER` | `--dlq-provider` | No | `log` | Dead letter queue provider. |
| `DLQ_FILE` | `--dlq-file` | No | `dlq.log` | File path for the file or directory DLQ providers. |
| `AUTO_MIGRATE` | n/a | No | `false` | Run database migrations on startup. |
| `CREATE_DIRS` | `--create-dirs` | No | `false` | Create missing directories on startup. |

Paths using the `s3://` scheme must include a bucket name and may specify an optional prefix, e.g. `s3://mybucket/uploads`.

### Dead Letter Queue Providers

The `DLQ_PROVIDER` setting selects how failed messages are recorded:

* `log` – writes messages to the application log (default)
* `file` – appends messages to a file using separator lines at `DLQ_FILE`. Each entry begins with an RFC3339 timestamp
* `dir` – creates one file per message under the directory `DLQ_FILE` using a KSUID name
* `db` – stores messages in the database
* `email` – sends messages to administrator addresses using the configured mail provider

Messages include any error details and full email contents when available.
Example config file:

```conf
DB_CONN=myuser:secret@tcp(localhost:3306)/a4web?parseTime=true
DB_DRIVER=mysql
EMAIL_PROVIDER=smtp
LISTEN=:8080
HOSTNAME=http://example.com:8080
```

Example files under `examples/` are generated automatically.


### Implementing Custom Providers

New email backends can be added by satisfying the `Provider` interface
defined in `internal/email/provider.go`:

```go
type Provider interface {
    Send(ctx context.Context, to mail.Address, rawEmailMessage []byte) error
}
```

Create a new file implementing this interface and add a case in
`providerFromConfig` that returns your provider. Providers that rely on optional
dependencies should live behind a build tag. See `internal/email/sendgrid.go` for an
example provider built with the `sendgrid` tag.

## Database Upgrades

Database schema changes are stored in the `migrations/` directory. Run
`goa4web db migrate` to apply all pending scripts using your configured
database connection. Set `AUTO_MIGRATE=true` to perform this step
automatically when the server starts.

When upgrading from v0.0.1 the script `migrations/0002.sql` must be applied.
This can be done manually using the `mysql` client:

```bash
mysql -u a4web -p a4web < migrations/0002.sql
```

The script adds new tables for notifications and email queues, updates existing
columns and records the schema version.

## Admin tools

### Permission section checker

The `/admin/permissions/sections` page lists all distinct values found in the `permissions.section` column. It provides buttons to convert existing rows between `writing` and `writings`. These once-off tools help normalise data if older migrations used inconsistent names.

The linked counts now let you drill down to view all permissions for a section via `/admin/permissions/sections/view?section=<name>`.

## Command Line Interface

The `goa4web` binary includes many administrative commands in addition to
`serve`, which starts the web server. Run `goa4web help` to see the full list of
subcommands. Most commands share the same configuration mechanism as the web
server and honour flags, config files and environment variables.

When using `user add` or `user add-admin`, omit the `--password` flag to be
prompted securely on the terminal.

Typical workflow:

```bash
# build the tool
go build -o goa4web ./cmd/goa4web
```

### Creating users

```bash
# create a regular account
./goa4web user add --username alice --email alice@example.com --password secret

# create an administrator
./goa4web user add-admin --username admin --email admin@example.com --password changeme

# promote an existing user to administrator
./goa4web user make-admin --username alice
```

### Managing permissions

```bash
# grant a permission
./goa4web perm grant --user alice --section forum --role moderator

# list all permissions
./goa4web perm list

# revoke a permission by ID
./goa4web perm revoke --id 42
```

### Database operations

```bash
# apply SQL migrations from ./migrations
./goa4web db migrate

# create a backup
./goa4web db backup --file backup.sql

# restore from a backup
./goa4web db restore --file backup.sql
```

### Configuration utilities

```bash
# show all available options
./goa4web config options --extended

# generate an env file with current values
./goa4web config as-env-file > config.env

# reload configuration without restarting
./goa4web config reload
```

## Docker Deployment

Container images can be built from the provided `Dockerfile`:

```bash
docker build -t goa4web .
```

Start the container with environment variables for your database connection:

```bash
docker run -p 8080:8080 \
  -e DB_DRIVER=sqlite \
  -e DB_CONN=file:/data/a4web.sqlite?_fk=1 \
  -e AUTO_MIGRATE=true \
  -v $(pwd)/data:/data \
  goa4web
```

### Docker Compose

An example `docker-compose.yaml` is provided under `examples/`. It runs MySQL
and automatically applies migrations on startup.

```bash
docker compose -f examples/docker-compose.yaml up
```

## Flutter Client Notifications

The server exposes a WebSocket endpoint at `/ws/notifications`.
Clients must include the normal session cookie when connecting.
Events published on the server's event bus are sent in JSON format only
when the connected user is subscribed to the matching event pattern.

Example Dart usage:
```dart
final channel = WebSocketChannel.connect(
  Uri.parse('ws://<host>/ws/notifications'),
);
```


